<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>集中アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1b26;
            color: #c0caf5;
            min-height: 100vh;
            margin: 0;
            box-sizing: border-box;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        #youtube-player-background {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 100vw;
            height: 100vh;
            transform: translate(-50%, -50%);
            z-index: -1;
            pointer-events: none;
        }
        #youtube-player-background iframe {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .fixed-card {
            background-color: rgba(31, 35, 53, 0.85);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: fixed;
            z-index: 10;
            margin: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .fixed-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.25);
        }

        #clock-container {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 20px;
            font-size: 2.8rem;
            font-weight: 600;
            color: #a9b1d6;
            letter-spacing: 2px;
            min-width: 160px;
            text-align: center;
        }

        #clock {
            white-space: nowrap;
        }

        #tasks-container {
            top: 0;
            right: 0;
            width: 280px;
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-right: 40px;
            position: relative;
            height: 40px;
        }

        .tasks-title {
            font-weight: 600;
            color: #a9b1d6;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
        }

        .tasks-toggle-btn {
            background: none;
            border: none;
            color: #a9b1d6;
            cursor: pointer;
            padding: 5px;
            transition: all 0.3s ease;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 12;
        }

        .tasks-toggle-btn:hover {
            color: #7aa2f7;
        }

        .tasks-toggle-btn.rotated {
            transform: translateY(-50%) rotate(180deg);
        }

        .tasks-content {
            transition: all 0.3s ease;
            overflow: hidden;
            height: auto;
            margin-top: 40px;
        }

        .tasks-content.collapsed {
            height: 0;
            margin: 0;
            padding: 0;
        }

        #tasks-container.collapsed {
            width: 60px;
            padding: 8px;
            height: 40px;
            overflow: hidden;
        }

        #tasks-container.collapsed .tasks-title {
            display: none;
        }

        #tasks-container.collapsed #add-task-float-btn {
            display: none;
        }

        #tasks-container.collapsed .tasks-content {
            margin-top: 0;
        }

        .card-title {
            font-weight: 600;
            color: #a9b1d6;
            border-bottom: 1px solid rgba(59, 66, 97, 0.5);
            padding-bottom: 8px;
            margin-bottom: 12px;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
        }

        #add-task-float-btn {
            position: absolute;
            top: 12px;
            right: 50px;
            width: 36px;
            height: 36px;
            background-color: #7aa2f7;
            color: #1a1b26;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 11;
            transition: all 0.2s ease;
        }

        #add-task-float-btn:hover {
            background-color: #567efb;
            transform: scale(1.1);
        }

        #new-task-input-field input {
            width: calc(100% - 50px);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #3b4261;
            background-color: rgba(41, 46, 66, 0.8);
            color: #c0caf5;
            font-size: 0.9rem;
            margin-right: 8px;
            transition: all 0.2s ease;
        }

        #new-task-input-field input:focus {
            outline: none;
            border-color: #7aa2f7;
            box-shadow: 0 0 0 2px rgba(122, 162, 247, 0.2);
        }

        #new-task-input-field button {
            padding: 8px 12px;
            border-radius: 6px;
            background-color: #7aa2f7;
            color: #1a1b26;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #new-task-input-field button:hover {
            background-color: #567efb;
            transform: translateY(-1px);
        }

        #task-list {
            list-style: none;
            padding: 0;
            overflow-y: auto;
            max-height: calc(100vh - 140px);
            font-size: 0.9rem;
        }

        #task-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(59, 66, 97, 0.3);
            transition: all 0.2s ease;
        }

        #task-list li:hover {
            background-color: rgba(41, 46, 66, 0.3);
            padding-left: 4px;
        }

        #task-list input[type="checkbox"] {
            margin-right: 8px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #7aa2f7;
        }

        .delete-task-btn {
            font-size: 0.9rem;
            color: #f7768e;
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .delete-task-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        #pomodoro-container {
            bottom: 0;
            left: 0;
            width: 220px;
        }

        #pomodoro-display {
            font-size: 2rem;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .pomodoro-buttons button {
            padding: 8px 12px;
            margin: 4px;
            font-size: 0.9rem;
            border-radius: 6px;
            background-color: #7aa2f7;
            color: #1a1b26;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pomodoro-buttons button:hover {
            background-color: #567efb;
            transform: translateY(-1px);
        }

        .pomodoro-buttons button:disabled {
            background-color: #3b4261;
            cursor: not-allowed;
            transform: none;
        }

        #settings-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background-color: rgba(31, 35, 53, 0.9);
            color: #7aa2f7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 20;
            transition: all 0.3s ease;
        }

        #settings-icon:hover {
            background-color: rgba(45, 50, 70, 0.95);
            transform: rotate(30deg);
        }

        #sound-icon {
            position: fixed;
            bottom: 20px;
            right: 100px;
            width: 44px;
            height: 44px;
            background-color: rgba(31, 35, 53, 0.9);
            color: #7aa2f7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 20;
            transition: all 0.3s ease;
        }

        #sound-icon:hover {
            background-color: rgba(45, 50, 70, 0.95);
            transform: rotate(30deg);
        }

        #sound-settings-panel {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 300px;
            background-color: rgba(45, 50, 70, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 19;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        #youtube-url-input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #3b4261;
            background-color: rgba(41, 46, 66, 0.8);
            color: #c0caf5;
            font-size: 0.9rem;
            margin-bottom: 12px;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        #youtube-url-input:focus {
            outline: none;
            border-color: #7aa2f7;
            box-shadow: 0 0 0 2px rgba(122, 162, 247, 0.2);
        }

        #set-youtube-bg-btn {
            padding: 10px 15px;
            border-radius: 6px;
            background-color: #7aa2f7;
            color: #1a1b26;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
        }

        #set-youtube-bg-btn:hover {
            background-color: #567efb;
            transform: translateY(-1px);
        }

        .message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(122, 162, 247, 0.95);
            color: #1a1b26;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
        }

        .message-box.show {
            opacity: 1;
            bottom: 30px;
            transform: translateX(-50%) translateY(-5px);
        }

        /* スクロールバーのカスタマイズ */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(36, 40, 59, 0.3);
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a5270;
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5c678a;
        }

        /* アニメーション */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fixed-card {
            animation: fadeIn 0.3s ease-out;
        }

        #video-controls-container {
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: auto; /* Adjust width to fit new controls */
            padding: 10px 15px;
            display: flex; /* For aligning items in the control bar */
            flex-direction: column; /* Stack main controls and volume controls */
            align-items: center;
        }
        .main-video-controls { /* Wrapper for prev, play/pause, next */
            display: flex;
            align-items: center;
            margin-bottom: 5px; /* Space between main controls and volume controls */
        }
        .main-video-controls button { padding: 6px 10px; margin: 0 3px; font-size: 0.85rem; }
        
        .volume-controls {
            display: flex;
            align-items: center;
            justify-content: center; /* Center volume controls */
            width: 100%;
            max-width: 180px; /* Limit width of volume controls area */
        }
        #mute-toggle-btn {
            background: none;
            border: none;
            color: #a9b1d6;
            cursor: pointer;
            font-size: 0.9rem; /* Slightly larger for easier clicking */
            padding: 5px;
        }
        #mute-toggle-btn:hover { color: #7aa2f7; }
        #volume-slider {
            width: 100px; /* Adjust width as needed */
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #3b4261;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 8px; /* Spacing around slider */
        }
        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: #7aa2f7;
            border-radius: 50%;
            cursor: pointer;
        }
        #volume-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: #7aa2f7;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        #video-status-display {
            display: none; /* 非表示にする */
            font-size: 0.8rem;
            margin-top: 0px;
            text-align: center;
            width: 100%;
        }
        #video-controls-container .card-title { display: none; }

        .progress-container {
            width: 100%;
            height: 4px;
            background-color: #3b4261;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }

        #progress-bar {
            height: 100%;
            background-color: #7aa2f7;
            width: 0%;
            transition: width 1s linear;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #a9b1d6;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
            color: #a9b1d6;
        }

        .setting-item input {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #3b4261;
            background-color: rgba(41, 46, 66, 0.8);
            color: #c0caf5;
        }

        .save-btn {
            width: 100%;
            padding: 10px;
            background-color: #7aa2f7;
            color: #1a1b26;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        #session-info {
            display: flex;
            justify-content: space-between;
            color: #a9b1d6;
            font-size: 0.8rem;
        }

        #mode-indicator {
            color: #9ece6a;
        }

        .pomodoro-header {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .toggle-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #a9b1d6;
            cursor: pointer;
            padding: 5px;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            color: #7aa2f7;
        }

        .toggle-btn.rotated {
            transform: translateY(-50%) rotate(180deg);
        }

        #pomodoro-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        #pomodoro-content.collapsed {
            height: 0;
            margin: 0;
            padding: 0;
        }

        #pomodoro-container.collapsed {
            padding: 8px 16px;
        }

        #pomodoro-container.collapsed #pomodoro-display {
            font-size: 2rem;
            margin: 0;
        }

        .confirmation-content {
            text-align: center;
            padding: 20px;
        }

        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .confirm-btn {
            padding: 8px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .confirm-yes {
            background-color: #7aa2f7;
            color: #1a1b26;
        }

        .confirm-yes:hover {
            background-color: #567efb;
            transform: translateY(-1px);
        }

        .confirm-no {
            background-color: #3b4261;
            color: #a9b1d6;
        }

        .confirm-no:hover {
            background-color: #4a5270;
            transform: translateY(-1px);
        }

        #confirmation-dialog {
            background-color: rgba(31, 35, 53, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        /* サウンド設定パネルのスタイル */
        .sound-settings-content {
            padding: 10px 0;
        }

        .sound-item {
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(41, 46, 66, 0.5);
            border-radius: 8px;
        }

        .sound-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .sound-toggle {
            appearance: none;
            width: 40px;
            height: 20px;
            background-color: #3b4261;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .sound-toggle:checked {
            background-color: #7aa2f7;
        }

        .sound-toggle::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #c0caf5;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .sound-toggle:checked::before {
            transform: translateX(20px);
        }

        .sound-name {
            color: #a9b1d6;
            font-size: 0.9rem;
        }

        .sound-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sound-volume {
            flex-grow: 1;
            height: 6px;
            -webkit-appearance: none;
            background: #3b4261;
            border-radius: 3px;
            outline: none;
        }

        .sound-volume::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #7aa2f7;
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-value {
            color: #a9b1d6;
            font-size: 0.8rem;
            min-width: 40px;
            text-align: right;
        }

        #youtube-settings-panel {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 300px;
            background-color: rgba(45, 50, 70, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 19;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .saved-videos-container {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .saved-video-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background-color: rgba(41, 46, 66, 0.5);
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .saved-video-item:hover {
            background-color: rgba(41, 46, 66, 0.8);
        }

        .saved-video-name {
            color: #a9b1d6;
            font-size: 0.9rem;
            margin-right: 10px;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .saved-video-buttons {
            display: flex;
            gap: 5px;
        }

        .saved-video-btn {
            background: none;
            border: none;
            color: #7aa2f7;
            cursor: pointer;
            padding: 4px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .saved-video-btn:hover {
            color: #567efb;
            transform: scale(1.1);
        }

        .saved-video-btn.delete {
            color: #f7768e;
        }

        .saved-video-btn.delete:hover {
            color: #ff5370;
        }

        .save-video-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #video-name-input {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #3b4261;
            background-color: rgba(41, 46, 66, 0.8);
            color: #c0caf5;
            font-size: 0.9rem;
        }

        #video-name-input:focus {
            outline: none;
            border-color: #7aa2f7;
            box-shadow: 0 0 0 2px rgba(122, 162, 247, 0.2);
        }

        #save-video-btn {
            padding: 8px 12px;
            border-radius: 6px;
            background-color: #7aa2f7;
            color: #1a1b26;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #save-video-btn:hover {
            background-color: #567efb;
            transform: translateY(-1px);
        }

        .settings-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(59, 66, 97, 0.5);
        }

        .settings-tab {
            padding: 8px 15px;
            color: #a9b1d6;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .settings-tab.active {
            color: #7aa2f7;
            border-bottom-color: #7aa2f7;
        }

        .settings-tab:hover {
            color: #7aa2f7;
        }

        .settings-content {
            display: none;
        }

        .settings-content.active {
            display: block;
        }

        #saved-videos-content {
            padding: 10px 0;
        }

        .save-video-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(41, 46, 66, 0.5);
            border-radius: 8px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            color: #a9b1d6;
            font-size: 0.9rem;
        }

        .form-group input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #3b4261;
            background-color: rgba(41, 46, 66, 0.8);
            color: #c0caf5;
            font-size: 0.9rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #7aa2f7;
            box-shadow: 0 0 0 2px rgba(122, 162, 247, 0.2);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 5px;
        }

        #save-video-btn {
            padding: 8px 15px;
            border-radius: 6px;
            background-color: #7aa2f7;
            color: #1a1b26;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #save-video-btn:hover {
            background-color: #567efb;
            transform: translateY(-1px);
        }

        #clear-form-btn {
            padding: 8px 15px;
            border-radius: 6px;
            background-color: #3b4261;
            color: #a9b1d6;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #clear-form-btn:hover {
            background-color: #4a5270;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div id="youtube-player-background"></div>

    <div id="clock-container" class="fixed-card">
        <div id="clock">00:00</div>
    </div>

    <div id="tasks-container" class="fixed-card">
        <div class="tasks-header">
            <h2 class="tasks-title">Tasks</h2>
            <button id="toggle-tasks" class="tasks-toggle-btn" title="折りたたみ"><i class="fas fa-chevron-up"></i></button>
        </div>
        <div class="tasks-content">
            <button id="add-task-float-btn" title="新しいタスクを追加"><i class="fas fa-plus"></i></button>
            <div id="new-task-input-field">
                <input type="text" id="task-input-actual" placeholder="タスク内容...">
                <button id="add-task-confirm-btn">追加</button>
            </div>
            <ul id="task-list"></ul>
        </div>
    </div>

    <div id="video-controls-container" class="fixed-card">
        <div class="main-video-controls">
            <button id="prev-video-btn" title="前のTone.jsトラック (機能変更検討)"><i class="fas fa-backward"></i></button>
            <button id="play-pause-video-btn" title="背景動画 再生/一時停止"><i class="fas fa-play"></i></button>
            <button id="next-video-btn" title="次のTone.jsトラック (機能変更検討)"><i class="fas fa-forward"></i></button>
        </div>
        <div class="volume-controls">
            <button id="mute-toggle-btn" title="ミュート"><i class="fas fa-volume-up"></i></button>
            <input type="range" id="volume-slider" min="0" max="100" value="50" title="音量">
        </div>
        <div id="video-status-display">背景動画: 停止中</div>
    </div>

    <div id="pomodoro-container" class="fixed-card">
        <div id="pomodoro-timer" class="text-center">
            <div class="pomodoro-header">
                <div id="pomodoro-display">25:00</div>
                <button id="toggle-pomodoro" class="toggle-btn" title="折りたたみ"><i class="fas fa-chevron-up"></i></button>
            </div>
            <div id="pomodoro-content">
                <div class="progress-container">
                    <div id="progress-bar"></div>
                </div>
                <div class="pomodoro-buttons">
                    <button id="start-pomodoro" class="pomodoro-btn" title="開始 (Space)"><i class="fas fa-play"></i></button>
                    <button id="pause-pomodoro" class="pomodoro-btn" disabled title="一時停止 (Space)"><i class="fas fa-pause"></i></button>
                    <button id="reset-pomodoro" class="pomodoro-btn" title="リセット (R)"><i class="fas fa-redo"></i></button>
                    <button id="settings-pomodoro" class="pomodoro-btn" title="設定 (S)"><i class="fas fa-cog"></i></button>
                </div>
                <div id="session-info" class="text-sm mt-2">
                    <span id="session-count">セッション: 0</span>
                    <span id="mode-indicator">作業中</span>
                </div>
            </div>
        </div>
    </div>

    <div id="pomodoro-settings" class="fixed-card" style="display: none;">
        <div class="settings-header">
            <h3>時間設定</h3>
            <button id="close-settings" class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="settings-content">
            <div class="setting-item">
                <label>作業時間 (分)</label>
                <input type="number" id="work-time" min="1" max="60" value="25">
            </div>
            <div class="setting-item">
                <label>短い休憩 (分)</label>
                <input type="number" id="short-break-time" min="1" max="30" value="5">
            </div>
            <div class="setting-item">
                <label>長い休憩 (分)</label>
                <input type="number" id="long-break-time" min="1" max="60" value="15">
            </div>
            <div class="setting-item">
                <label>長い休憩までのセッション数</label>
                <input type="number" id="sessions-before-long-break" min="1" max="10" value="4">
            </div>
            <button id="save-settings" class="save-btn">保存</button>
        </div>
    </div>

    <div id="settings-icon" title="背景設定">
        <i class="fas fa-cog"></i>
    </div>
    <div id="sound-icon" title="サウンド設定">
        <i class="fas fa-volume-up"></i>
    </div>
    <div id="sound-settings-panel" class="fixed-card" style="display: none; margin:0;">
        <div class="settings-header">
            <h3>サウンド設定</h3>
            <button id="close-sound-settings" class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="sound-settings-content">
            <div class="sound-item">
                <div class="sound-header">
                    <label>
                        <input type="checkbox" id="rain-sound-toggle" class="sound-toggle">
                        <span class="sound-name">雨の音</span>
                    </label>
                </div>
                <div class="sound-controls">
                    <input type="range" id="rain-volume" class="sound-volume" min="0" max="100" value="50">
                    <span class="volume-value">50%</span>
                </div>
            </div>
            <div class="sound-item">
                <div class="sound-header">
                    <label>
                        <input type="checkbox" id="keyboard-sound-toggle" class="sound-toggle">
                        <span class="sound-name">キーボード音</span>
                    </label>
                </div>
                <div class="sound-controls">
                    <input type="range" id="keyboard-volume" class="sound-volume" min="0" max="100" value="50">
                    <span class="volume-value">50%</span>
                </div>
            </div>
            <div class="sound-item">
                <div class="sound-header">
                    <label>
                        <input type="checkbox" id="whitenoise-sound-toggle" class="sound-toggle">
                        <span class="sound-name">ホワイトノイズ</span>
                    </label>
                </div>
                <div class="sound-controls">
                    <input type="range" id="whitenoise-volume" class="sound-volume" min="0" max="100" value="50">
                    <span class="volume-value">50%</span>
                </div>
            </div>
        </div>
    </div>
    <div id="youtube-settings-panel" class="fixed-card" style="margin:0;">
        <div class="settings-tabs">
            <div class="settings-tab active" data-tab="quick-set">クイック設定</div>
            <div class="settings-tab" data-tab="saved-videos">保存済み動画</div>
        </div>
        
        <div class="settings-content active" id="quick-set-content">
            <label for="youtube-url-input">YouTube 動画 URL:</label>
            <input type="text" id="youtube-url-input" placeholder="例: https://www.youtube.com/watch?v=VIDEO_ID">
            <button id="set-youtube-bg-btn">背景を設定</button>
        </div>

        <div class="settings-content" id="saved-videos-content">
            <div class="save-video-form">
                <div class="form-group">
                    <label for="saved-video-url">YouTube 動画 URL:</label>
                    <input type="text" id="saved-video-url" placeholder="例: https://www.youtube.com/watch?v=VIDEO_ID">
                </div>
                <div class="form-group">
                    <label for="video-name-input">動画の名前:</label>
                    <input type="text" id="video-name-input" placeholder="例: お気に入りの作業用BGM">
                </div>
                <div class="form-actions">
                    <button id="clear-form-btn">クリア</button>
                    <button id="save-video-btn">保存</button>
                </div>
            </div>
            <div class="saved-videos-container" id="saved-videos-list">
                <!-- 保存された動画のリストがここに表示されます -->
            </div>
        </div>
    </div>

    <div id="message-box-container"></div>

    <div id="confirmation-dialog" class="fixed-card" style="display: none; z-index: 1000; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <div class="confirmation-content">
            <h3 id="confirmation-title" class="text-lg mb-4"></h3>
            <div class="confirmation-buttons">
                <button id="confirm-yes" class="confirm-btn confirm-yes">はい</button>
                <button id="confirm-no" class="confirm-btn confirm-no">いいえ</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const clockElement = document.getElementById('clock');
        const addTaskFloatBtn = document.getElementById('add-task-float-btn');
        const newTaskInputField = document.getElementById('new-task-input-field');
        const taskInputActual = document.getElementById('task-input-actual');
        const addTaskConfirmBtn = document.getElementById('add-task-confirm-btn');
        const taskList = document.getElementById('task-list');
        const pomodoroDisplay = document.getElementById('pomodoro-display');
        const startPomodoroBtn = document.getElementById('start-pomodoro');
        const pausePomodoroBtn = document.getElementById('pause-pomodoro');
        const resetPomodoroBtn = document.getElementById('reset-pomodoro');
        
        const playPauseVideoBtn = document.getElementById('play-pause-video-btn');
        const prevVideoBtn = document.getElementById('prev-video-btn');
        const nextVideoBtn = document.getElementById('next-video-btn');
        const videoStatusDisplay = document.getElementById('video-status-display');
        const muteToggleBtn = document.getElementById('mute-toggle-btn');
        const volumeSlider = document.getElementById('volume-slider');


        const messageBoxContainer = document.getElementById('message-box-container');

        const settingsIcon = document.getElementById('settings-icon');
        const soundIcon = document.getElementById('sound-icon');
        const youtubeSettingsPanel = document.getElementById('youtube-settings-panel');
        const youtubeUrlInput = document.getElementById('youtube-url-input');
        const setYoutubeBgBtn = document.getElementById('set-youtube-bg-btn');
        let ytPlayer;
        let isYouTubeVideoPlaying = false;

        // --- App State ---
        let tasks = [];
        let pomodoroTimerInterval;
        let pomodoroTime = 25 * 60;
        let isPomodoroRunning = false;
        let currentPomodoroMode = 'work';
        let workDuration = 25 * 60;
        let shortBreakDuration = 5 * 60;
        let longBreakDuration = 15 * 60;
        let sessionsBeforeLongBreak = 4;
        let isLongBreak = false;
        let totalTime = workDuration;
        let elapsedTime = 0;

        let synth = null;
        const toneTracks = [
            { title: "静寂のメロディ", notes: ["C3", "E3", "G3", "C4"] },
            { title: "星空のハーモニー", notes: ["D3", "F3", "A3", "D4"] },
            { title: "夜明けのチル", notes: ["E3", "G3", "B3", "E4"] }
        ];
        let currentToneTrackIndex = 0;
        let toneSequence;

        let isPomodoroCollapsed = false;
        let isTasksCollapsed = false;

        let confirmationCallback = null;

        // サウンド関連の変数
        let rainSound, keyboardSound, whiteNoiseSound;
        let audioContext;
        let rainPlayer;
        let keyboardPlayer;
        let noiseNode;

        // サウンドの初期化
        async function initializeAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 雨の音の生成
                rainPlayer = new Tone.Player("Sounds/rain.mp3").toDestination();
                rainPlayer.loop = true;
                rainPlayer.volume.value = -10;

                // キーボード音の生成
                keyboardPlayer = new Tone.Player("Sounds/PC-Keyboard06-01(Mid).mp3").toDestination();
                keyboardPlayer.loop = true;
                keyboardPlayer.volume.value = -20;

                // ホワイトノイズの生成
                noiseNode = audioContext.createGain();
                noiseNode.gain.value = 0;
                const bufferSize = audioContext.sampleRate * 2;
                const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                const output = noiseBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = Math.random() * 2 - 1;
                }
                const whiteNoise = audioContext.createBufferSource();
                whiteNoise.buffer = noiseBuffer;
                whiteNoise.loop = true;
                whiteNoise.connect(noiseNode);
                noiseNode.connect(audioContext.destination);
                whiteNoise.start();

                // デフォルトの音量を設定
                document.getElementById('whitenoise-volume').value = 50; // デフォルトを50%に設定
                document.getElementById('whitenoise-volume').nextElementSibling.textContent = '50%';

                // トグルスイッチのイベントリスナー
                document.getElementById('rain-sound-toggle').addEventListener('change', (e) => {
                    if (Tone.context.state !== 'running') {
                        Tone.start();
                    }
                    if (e.target.checked) {
                        rainPlayer.start();
                    } else {
                        rainPlayer.stop();
                    }
                });

                document.getElementById('keyboard-sound-toggle').addEventListener('change', (e) => {
                    if (Tone.context.state !== 'running') {
                        Tone.start();
                    }
                    if (e.target.checked) {
                        keyboardPlayer.start();
                    } else {
                        keyboardPlayer.stop();
                    }
                });

                document.getElementById('whitenoise-sound-toggle').addEventListener('change', (e) => {
                    if (audioContext.state !== 'running') {
                        audioContext.resume();
                    }
                    const volume = e.target.checked ? document.getElementById('whitenoise-volume').value / 100 * 0.1 : 0;
                    noiseNode.gain.setValueAtTime(volume, audioContext.currentTime);
                });

                document.getElementById('rain-volume').addEventListener('input', (e) => {
                    const volume = e.target.value / 100;
                    rainPlayer.volume.value = (volume * 100) - 100; // -100 to 0 dB range
                    e.target.nextElementSibling.textContent = `${e.target.value}%`;
                });

                document.getElementById('keyboard-volume').addEventListener('input', (e) => {
                    const volume = e.target.value / 100;
                    keyboardPlayer.volume.value = (volume * 100) - 100; // -100 to 0 dB range
                    e.target.nextElementSibling.textContent = `${e.target.value}%`;
                });

                document.getElementById('whitenoise-volume').addEventListener('input', (e) => {
                    const volume = e.target.value / 100 * 0.1; // 最大音量を10%に制限
                    if (document.getElementById('whitenoise-sound-toggle').checked) {
                        noiseNode.gain.setValueAtTime(volume, audioContext.currentTime);
                    }
                    e.target.nextElementSibling.textContent = `${e.target.value}%`;
                });

            } catch (error) {
                console.error('Audio initialization failed:', error);
                showMessage('サウンドの初期化に失敗しました', 3000);
            }
        }

        // サウンド設定パネルの閉じるボタン
        document.getElementById('close-sound-settings').addEventListener('click', () => {
            document.getElementById('sound-settings-panel').style.display = 'none';
        });

        // キーボード入力時のサウンド再生
        document.addEventListener('keydown', (e) => {
            if (keyboardSound && document.getElementById('keyboard-sound-toggle').checked) {
                const volume = document.getElementById('keyboard-volume').value / 100;
                keyboardSound.gain.setValueAtTime(volume, audioContext.currentTime);
                keyboardSound.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
            }
        });

        // --- Utility Functions ---
        function showMessage(message, duration = 2500) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-box';
            messageDiv.textContent = message;
            messageBoxContainer.appendChild(messageDiv);
            void messageDiv.offsetWidth;
            messageDiv.classList.add('show');
            setTimeout(() => {
                messageDiv.classList.remove('show');
                setTimeout(() => {
                    if (messageBoxContainer.contains(messageDiv)) {
                         messageBoxContainer.removeChild(messageDiv);
                    }
                }, 300);
            }, duration);
        }

        // --- YouTube Background Logic ---
        function loadYouTubeAPI() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api"; // Corrected API URL
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        window.onYouTubeIframeAPIReady = function() {
            const savedVideoId = localStorage.getItem('youtubeBgVideoId');
            const savedPlaylistId = localStorage.getItem('youtubeBgPlaylistId');
            const savedVolume = localStorage.getItem('youtubeBgVolume');
            
            if (savedVideoId || savedPlaylistId) {
                loadYouTubeVideo({ videoId: savedVideoId, playlistId: savedPlaylistId }, savedVolume ? parseInt(savedVolume) : 50);
            } else {
                // デフォルトの動画IDを設定
                const defaultVideoId = 'X9IOZ4trc2U';
                loadYouTubeVideo({ videoId: defaultVideoId }, savedVolume ? parseInt(savedVolume) : 50);
                localStorage.setItem('youtubeBgVideoId', defaultVideoId);
            }
        }

        function extractYouTubeVideoId(url) {
            let videoId = null;
            let playlistId = null;
            try {
                const urlObj = new URL(url);
                // Standard YouTube watch URLs
                if ((urlObj.hostname === 'www.youtube.com' || urlObj.hostname === 'youtube.com') && urlObj.pathname === '/watch') {
                    videoId = urlObj.searchParams.get('v');
                    playlistId = urlObj.searchParams.get('list');
                } 
                // Shortened youtu.be URLs
                else if (urlObj.hostname === 'youtu.be') {
                    videoId = urlObj.pathname.slice(1);
                }
                // Embed URLs
                else if ((urlObj.hostname === 'www.youtube.com' || urlObj.hostname === 'youtube.com') && urlObj.pathname.startsWith('/embed/')) {
                    videoId = urlObj.pathname.split('/embed/')[1].split('?')[0];
                    playlistId = urlObj.searchParams.get('list');
                }
                // Playlist URLs
                else if ((urlObj.hostname === 'www.youtube.com' || urlObj.hostname === 'youtube.com') && urlObj.pathname.startsWith('/playlist')) {
                    playlistId = urlObj.searchParams.get('list');
                }
            } catch (e) {
                // console.warn("URL parsing with new URL() failed, trying regex for:", url, e);
            }
            
            // Fallback regex if URL parsing failed or for plain IDs / other formats
            if (!videoId && !playlistId) { 
                const videoRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/|^)([a-zA-Z0-9_-]{11})/;
                const playlistRegex = /[?&]list=([^&]+)/;
                const videoMatch = url.match(videoRegex);
                const playlistMatch = url.match(playlistRegex);
                if (videoMatch) videoId = videoMatch[1];
                if (playlistMatch) playlistId = playlistMatch[1];
            }
            return { videoId, playlistId };
        }
        
        function updateVolumeControlsUI(volume, isMuted) {
            if (volumeSlider) volumeSlider.value = volume;
            if (muteToggleBtn) {
                muteToggleBtn.innerHTML = isMuted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
                muteToggleBtn.title = isMuted ? "ミュート解除" : "ミュート";
            }
        }


        function loadYouTubeVideo(videoId, initialVolume = 50) {
            if (!videoId) {
                showMessage("有効なYouTube動画IDがありません。", 3000);
                if (ytPlayer && typeof ytPlayer.destroy === 'function') {
                    ytPlayer.destroy(); ytPlayer = null;
                }
                document.getElementById('youtube-player-background').innerHTML = '';
                videoStatusDisplay.textContent = "背景動画: 読み込みエラー";
                playPauseVideoBtn.innerHTML = '<i class="fas fa-play"></i>';
                isYouTubeVideoPlaying = false;
                updateVolumeControlsUI(initialVolume, true); // Reset volume UI
                return;
            }

            const playerVars = {
                autoplay: 1, controls: 0, showinfo: 0, modestbranding: 1,
                loop: 1, fs: 0, cc_load_policy: 0,
                iv_load_policy: 3, autohide: 0, 
                mute: 0, // Ensure sound is on by default
                playsinline: 1
            };

            // 再生リストがある場合は設定
            if (videoId.playlistId) {
                playerVars.listType = 'playlist';
                playerVars.list = videoId.playlistId;
            } else {
                playerVars.playlist = videoId.videoId;
            }

            if (ytPlayer && typeof ytPlayer.loadVideoById === 'function') {
                if (videoId.playlistId) {
                    ytPlayer.loadPlaylist(videoId.playlistId);
                } else {
                    ytPlayer.loadVideoById({videoId: videoId.videoId});
                }
            } else {
                if (ytPlayer && typeof ytPlayer.destroy === 'function') { ytPlayer.destroy(); }
                document.getElementById('youtube-player-background').innerHTML = '';
                ytPlayer = new YT.Player('youtube-player-background', {
                    videoId: videoId.videoId,
                    playerVars: playerVars,
                    events: {
                        'onReady': (event) => {
                            event.target.setVolume(initialVolume);
                            if(event.target.isMuted()) {
                                event.target.unMute();
                            }
                            event.target.playVideo();
                            updateVolumeControlsUI(event.target.getVolume(), event.target.isMuted());
                        },
                        'onStateChange': onPlayerStateChange,
                        'onError': (event) => {
                            console.error("YouTube Player Error:", event.data);
                            showMessage("背景動画の読み込みに失敗しました。", 3000);
                            if (ytPlayer && typeof ytPlayer.destroy === 'function') {
                                ytPlayer.destroy(); ytPlayer = null;
                            }
                            document.getElementById('youtube-player-background').innerHTML = '';
                            videoStatusDisplay.textContent = "背景動画: 読み込みエラー";
                            playPauseVideoBtn.innerHTML = '<i class="fas fa-play"></i>';
                            isYouTubeVideoPlaying = false;
                            updateVolumeControlsUI(initialVolume, true);
                        }
                    }
                });
            }
            localStorage.setItem('youtubeBgVideoId', videoId.videoId);
            if (videoId.playlistId) {
                localStorage.setItem('youtubeBgPlaylistId', videoId.playlistId);
            }
        }
        
        function onPlayerStateChange(event) {
            const player = event.target;
            if (event.data == YT.PlayerState.PLAYING) {
                isYouTubeVideoPlaying = true;
                playPauseVideoBtn.innerHTML = '<i class="fas fa-pause"></i>';
                videoStatusDisplay.textContent = "背景動画: 再生中";
            } else if (event.data == YT.PlayerState.PAUSED) {
                isYouTubeVideoPlaying = false;
                playPauseVideoBtn.innerHTML = '<i class="fas fa-play"></i>';
                videoStatusDisplay.textContent = "背景動画: 一時停止中";
            } else if (event.data == YT.PlayerState.ENDED) {
                isYouTubeVideoPlaying = false; 
                playPauseVideoBtn.innerHTML = '<i class="fas fa-play"></i>';
                videoStatusDisplay.textContent = "背景動画: 停止中";
            } else if (event.data == YT.PlayerState.CUED) {
                 videoStatusDisplay.textContent = "背景動画: 準備完了";
            } else if (event.data == YT.PlayerState.UNSTARTED) {
                 videoStatusDisplay.textContent = "背景動画: 未開始";
            }
            // Always update volume controls on state change as mute state might change
            if (player && typeof player.getVolume === 'function' && typeof player.isMuted === 'function') {
                updateVolumeControlsUI(player.getVolume(), player.isMuted());
            }
        }

        settingsIcon.addEventListener('click', () => {
            youtubeSettingsPanel.style.display = youtubeSettingsPanel.style.display === 'none' ? 'block' : 'none';
        });

        soundIcon.addEventListener('click', () => {
            document.getElementById('sound-settings-panel').style.display = document.getElementById('sound-settings-panel').style.display === 'none' ? 'block' : 'none';
        });

        setYoutubeBgBtn.addEventListener('click', () => {
            const url = youtubeUrlInput.value.trim();
            const currentVolume = ytPlayer && typeof ytPlayer.getVolume === 'function' ? ytPlayer.getVolume() : 50;
            if (url) {
                const { videoId, playlistId } = extractYouTubeVideoId(url);
                if (videoId || playlistId) {
                    // 既存のプレーヤーを破棄
                    if (ytPlayer && typeof ytPlayer.destroy === 'function') {
                        ytPlayer.destroy();
                        ytPlayer = null;
                    }
                    document.getElementById('youtube-player-background').innerHTML = '';
                    
                    // 新しいプレーヤーを作成
                    loadYouTubeVideo({ videoId, playlistId }, currentVolume);
                    youtubeUrlInput.value = '';
                    youtubeSettingsPanel.style.display = 'none';
                    showMessage("背景動画を設定しました。", 2000);
                } else {
                    showMessage("無効なYouTube URLまたは動画IDです。", 3000);
                }
            } else {
                // デフォルトの動画IDを設定
                const defaultVideoId = 'X9IOZ4trc2U';
                // 既存のプレーヤーを破棄
                if (ytPlayer && typeof ytPlayer.destroy === 'function') {
                    ytPlayer.destroy();
                    ytPlayer = null;
                }
                document.getElementById('youtube-player-background').innerHTML = '';
                
                // 新しいプレーヤーを作成
                loadYouTubeVideo({ videoId: defaultVideoId }, currentVolume);
                localStorage.setItem('youtubeBgVideoId', defaultVideoId);
                youtubeUrlInput.value = '';
                youtubeSettingsPanel.style.display = 'none';
                showMessage("デフォルトの背景動画を設定しました。", 2000);
            }
        });

        playPauseVideoBtn.addEventListener('click', () => {
            if (!ytPlayer || typeof ytPlayer.getPlayerState !== 'function') {
                showMessage("背景動画プレーヤーが準備できていません。", 2000);
                return;
            }
            const playerState = ytPlayer.getPlayerState();
            if (playerState === YT.PlayerState.PLAYING) {
                ytPlayer.pauseVideo();
            } else {
                ytPlayer.playVideo();
            }
        });

        muteToggleBtn.addEventListener('click', () => {
            if (!ytPlayer || typeof ytPlayer.isMuted !== 'function') {
                showMessage("背景動画プレーヤーが準備できていません。", 2000);
                return;
            }
            if (ytPlayer.isMuted()) {
                ytPlayer.unMute();
            } else {
                ytPlayer.mute();
            }
            // Update UI immediately, though onPlayerStateChange might also catch some mute changes
            updateVolumeControlsUI(ytPlayer.getVolume(), ytPlayer.isMuted());
        });

        volumeSlider.addEventListener('input', () => {
            if (!ytPlayer || typeof ytPlayer.setVolume !== 'function') {
                // showMessage("背景動画プレーヤーが準備できていません。", 1000); // Can be noisy
                return;
            }
            const newVolume = parseInt(volumeSlider.value);
            ytPlayer.setVolume(newVolume);
            localStorage.setItem('youtubeBgVolume', newVolume);
            // If user is sliding volume up and it's muted, unmute it.
            if (newVolume > 0 && ytPlayer.isMuted()) {
                ytPlayer.unMute();
            }
            updateVolumeControlsUI(newVolume, ytPlayer.isMuted());
        });


        async function initializeToneAudio() {
            if (!synth) {
                try {
                    await Tone.start();
                    synth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: "fatsine" },
                        envelope: { attack: 0.2, decay: 0.5, sustain: 0.3, release: 1 },
                        volume: -20
                    }).toDestination();
                } catch (error) { console.error("Tone.js init failed:", error); }
            }
        }
        prevVideoBtn.addEventListener('click', async () => {
            if (!ytPlayer || typeof ytPlayer.getPlayerState !== 'function') {
                showMessage("背景動画プレーヤーが準備できていません。", 2000);
                return;
            }
            if (ytPlayer.getPlaylist && ytPlayer.getPlaylist().length > 0) {
                ytPlayer.previousVideo();
                showMessage("前の動画に移動しました", 1000);
            } else {
                showMessage("再生リストが設定されていません", 2000);
            }
        });
        nextVideoBtn.addEventListener('click', async () => {
            if (!ytPlayer || typeof ytPlayer.getPlayerState !== 'function') {
                showMessage("背景動画プレーヤーが準備できていません。", 2000);
                return;
            }
            if (ytPlayer.getPlaylist && ytPlayer.getPlaylist().length > 0) {
                ytPlayer.nextVideo();
                showMessage("次の動画に移動しました", 1000);
            } else {
                showMessage("再生リストが設定されていません", 2000);
            }
        });

        function updateClock() {
            const now = new Date();
            clockElement.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        }
        setInterval(updateClock, 1000);

        function renderTasks() {
            taskList.innerHTML = '';
            tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = task.completed ? 'completed' : '';
                const taskContent = document.createElement('div');
                taskContent.className = 'flex items-center flex-grow';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.checked = task.completed; checkbox.dataset.index = index;
                checkbox.addEventListener('change', toggleTaskCompletion);
                const span = document.createElement('span');
                span.textContent = task.text;
                span.className = 'ml-2 ' + (task.completed ? 'line-through text-gray-500' : '');
                taskContent.appendChild(checkbox); taskContent.appendChild(span);
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.className = 'delete-task-btn ml-auto text-red-400 hover:text-red-600';
                deleteBtn.dataset.index = index;
                deleteBtn.addEventListener('click', deleteTask);
                li.appendChild(taskContent); li.appendChild(deleteBtn);
                taskList.appendChild(li);
            });
            saveTasksToLocalStorage();
        }
        addTaskFloatBtn.addEventListener('click', () => {
            newTaskInputField.style.display = newTaskInputField.style.display === 'none' ? 'flex' : 'none';
            if (newTaskInputField.style.display === 'flex') taskInputActual.focus();
        });
        function addNewTask() {
            const taskText = taskInputActual.value.trim();
            if (taskText) {
                tasks.push({ text: taskText, completed: false });
                taskInputActual.value = ''; renderTasks();
                newTaskInputField.style.display = 'none';
            } else { showMessage("タスク内容を入力", 1500); }
        }
        addTaskConfirmBtn.addEventListener('click', addNewTask);
        taskInputActual.addEventListener('keypress', (e) => { if (e.key === 'Enter') addNewTask(); });
        function toggleTaskCompletion(event) {
            tasks[event.target.dataset.index].completed = !tasks[event.target.dataset.index].completed;
            renderTasks();
        }
        function deleteTask(event) {
            const button = event.target.closest('.delete-task-btn');
            if (button) {
                tasks.splice(button.dataset.index, 1); renderTasks();
                showMessage("タスク削除", 1000);
            }
        }
        function saveTasksToLocalStorage() { localStorage.setItem('focusAppTasks_edge', JSON.stringify(tasks)); }
        function loadTasksFromLocalStorage() {
            const storedTasks = localStorage.getItem('focusAppTasks_edge');
            if (storedTasks) { tasks = JSON.parse(storedTasks); renderTasks(); }
        }

        function updateProgressBar() {
            const progress = (elapsedTime / totalTime) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        function updatePomodoroDisplay() {
            const minutes = String(Math.floor(pomodoroTime / 60)).padStart(2, '0');
            const seconds = String(pomodoroTime % 60).padStart(2, '0');
            pomodoroDisplay.textContent = `${minutes}:${seconds}`;
            
            const modeText = isBreak ? (isLongBreak ? '長い休憩' : '短い休憩') : '作業中';
            document.getElementById('mode-indicator').textContent = modeText;
            document.getElementById('mode-indicator').style.color = isBreak ? '#ff9e64' : '#9ece6a';
            
            document.title = `${minutes}:${seconds} - ${modeText}`;
        }

        function showConfirmationDialog(title, callback) {
            const dialog = document.getElementById('confirmation-dialog');
            const titleElement = document.getElementById('confirmation-title');
            
            titleElement.textContent = title;
            dialog.style.display = 'block';
            confirmationCallback = callback;
        }

        function hideConfirmationDialog() {
            const dialog = document.getElementById('confirmation-dialog');
            dialog.style.display = 'none';
            confirmationCallback = null;
        }

        document.getElementById('confirm-yes').addEventListener('click', () => {
            if (confirmationCallback) {
                confirmationCallback(true);
            }
            hideConfirmationDialog();
        });

        document.getElementById('confirm-no').addEventListener('click', () => {
            if (confirmationCallback) {
                confirmationCallback(false);
            }
            hideConfirmationDialog();
        });

        function startPomodoroTimer() {
            if (isPomodoroRunning) return;
            isPomodoroRunning = true;
            startPomodoroBtn.disabled = true;
            pausePomodoroBtn.disabled = false;
            
            totalTime = pomodoroTime;
            elapsedTime = 0;
            updateProgressBar();
            
            initializeToneAudio().then(() => {
                if (synth) synth.triggerAttackRelease("C4", "8n", Tone.now() + 0.1);
            });

            pomodoroTimerInterval = setInterval(() => {
                pomodoroTime--;
                elapsedTime++;
                updatePomodoroDisplay();
                updateProgressBar();
                
                if (pomodoroTime < 0) {
                    clearInterval(pomodoroTimerInterval);
                    isPomodoroRunning = false;
                    
                    if (synth) synth.triggerAttackRelease("G4", "4n", Tone.now() + 0.1);
                    
                    isBreak = !isBreak;
                    if (!isBreak) {
                        sessionCount++;
                        document.getElementById('session-count').textContent = `セッション: ${sessionCount}`;
                        
                        // 長い休憩の判定
                        isLongBreak = sessionCount % sessionsBeforeLongBreak === 0;
                    }
                    
                    // 次のセッションの時間を設定
                    pomodoroTime = isBreak ? (isLongBreak ? longBreakDuration : shortBreakDuration) : workDuration;
                    totalTime = pomodoroTime;
                    elapsedTime = 0;
                    
                    // 表示を更新
                    updatePomodoroDisplay();
                    updateProgressBar();
                    
                    // ボタンの状態を更新
                    startPomodoroBtn.disabled = false;
                    pausePomodoroBtn.disabled = true;
                    
                    // 通知を表示
                    if (Notification.permission === "granted") {
                        const message = isBreak 
                            ? (isLongBreak ? "お疲れ様でした！長い休憩を始めましょう" : "お疲れ様でした！短い休憩を始めましょう")
                            : "休憩終了！作業を再開しましょう";
                        new Notification(message);
                    }
                    
                    // メッセージを表示
                    const message = isBreak 
                        ? (isLongBreak ? "長い休憩を始めましょう" : "短い休憩を始めましょう")
                        : "作業を再開しましょう";
                    showMessage(message, 3000);
                    
                    // セッション切り替えの確認
                    const breakType = isBreak ? (isLongBreak ? "長い休憩" : "短い休憩") : "作業";
                    const duration = isBreak 
                        ? (isLongBreak ? longBreakDuration / 60 : shortBreakDuration / 60)
                        : workDuration / 60;
                    const confirmMessage = `${breakType}（${duration}分）を始めますか？`;
                    
                    showConfirmationDialog(confirmMessage, (confirmed) => {
                        if (confirmed) {
                            // 確認された場合、1秒後に次のセッションを開始
                            setTimeout(() => {
                                if (!isPomodoroRunning) {
                                    startPomodoroTimer();
                                }
                            }, 1000);
                        } else {
                            // キャンセルされた場合、現在のモードを維持
                            if (isBreak) {
                                isBreak = false;
                                pomodoroTime = workDuration;
                                totalTime = workDuration;
                            } else {
                                isBreak = true;
                                pomodoroTime = isLongBreak ? longBreakDuration : shortBreakDuration;
                                totalTime = pomodoroTime;
                            }
                            updatePomodoroDisplay();
                            updateProgressBar();
                        }
                    });
                }
            }, 1000);
        }
        function pausePomodoroTimer() {
            if (!isPomodoroRunning) return;
            isPomodoroRunning = false; clearInterval(pomodoroTimerInterval);
            startPomodoroBtn.disabled = false; startPomodoroBtn.textContent = "再開"; pausePomodoroBtn.disabled = true;
        }
        function resetPomodoroTimer() {
            clearInterval(pomodoroTimerInterval);
            isPomodoroRunning = false;
            isBreak = false;
            isLongBreak = false;
            pomodoroTime = workDuration;
            totalTime = workDuration;
            elapsedTime = 0;
            sessionCount = 0;
            document.getElementById('session-count').textContent = `セッション: ${sessionCount}`;
            updatePomodoroDisplay();
            updateProgressBar();
            startPomodoroBtn.disabled = false;
            pausePomodoroBtn.disabled = true;
            document.title = "集中アプリ";
            showMessage("タイマーをリセットしました", 2000);
        }
        startPomodoroBtn.addEventListener('click', startPomodoroTimer);
        pausePomodoroBtn.addEventListener('click', pausePomodoroTimer);
        resetPomodoroBtn.addEventListener('click', resetPomodoroTimer);

        let sessionCount = 0;
        let isBreak = false;

        function saveSettings() {
            const settings = {
                workTime: parseInt(document.getElementById('work-time').value),
                shortBreakTime: parseInt(document.getElementById('short-break-time').value),
                longBreakTime: parseInt(document.getElementById('long-break-time').value),
                sessionsBeforeLongBreak: parseInt(document.getElementById('sessions-before-long-break').value)
            };
            
            localStorage.setItem('pomodoroSettings', JSON.stringify(settings));
            
            workDuration = settings.workTime * 60;
            shortBreakDuration = settings.shortBreakTime * 60;
            longBreakDuration = settings.longBreakTime * 60;
            sessionsBeforeLongBreak = settings.sessionsBeforeLongBreak;
            
            if (!isPomodoroRunning) {
                pomodoroTime = workDuration;
                updatePomodoroDisplay();
            }
            
            document.getElementById('pomodoro-settings').style.display = 'none';
            showMessage("設定を保存しました");
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('pomodoroSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                document.getElementById('work-time').value = settings.workTime;
                document.getElementById('short-break-time').value = settings.shortBreakTime;
                document.getElementById('long-break-time').value = settings.longBreakTime;
                document.getElementById('sessions-before-long-break').value = settings.sessionsBeforeLongBreak;
                
                workDuration = settings.workTime * 60;
                shortBreakDuration = settings.shortBreakTime * 60;
                longBreakDuration = settings.longBreakTime * 60;
                sessionsBeforeLongBreak = settings.sessionsBeforeLongBreak;
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !e.repeat) {
                e.preventDefault();
                if (isPomodoroRunning) {
                    pausePomodoroTimer();
                } else {
                    startPomodoroTimer();
                }
            } else if (e.code === 'KeyR') {
                resetPomodoroTimer();
            }
        });

        document.getElementById('settings-pomodoro').addEventListener('click', () => {
            document.getElementById('pomodoro-settings').style.display = 'block';
        });

        document.getElementById('close-settings').addEventListener('click', () => {
            document.getElementById('pomodoro-settings').style.display = 'none';
        });

        document.getElementById('save-settings').addEventListener('click', saveSettings);

        function togglePomodoro() {
            const content = document.getElementById('pomodoro-content');
            const container = document.getElementById('pomodoro-container');
            const toggleBtn = document.getElementById('toggle-pomodoro');
            
            isPomodoroCollapsed = !isPomodoroCollapsed;
            content.classList.toggle('collapsed');
            container.classList.toggle('collapsed');
            toggleBtn.classList.toggle('rotated');
            
            // 状態を保存
            localStorage.setItem('pomodoroCollapsed', isPomodoroCollapsed);
        }

        // イベントリスナーの追加
        document.getElementById('toggle-pomodoro').addEventListener('click', togglePomodoro);

        function toggleTasks() {
            const content = document.querySelector('.tasks-content');
            const container = document.getElementById('tasks-container');
            const toggleBtn = document.getElementById('toggle-tasks');
            
            isTasksCollapsed = !isTasksCollapsed;
            content.classList.toggle('collapsed');
            container.classList.toggle('collapsed');
            toggleBtn.classList.toggle('rotated');
            
            // 状態を保存
            localStorage.setItem('tasksCollapsed', isTasksCollapsed);
        }

        // イベントリスナーの追加
        document.getElementById('toggle-tasks').addEventListener('click', toggleTasks);

        // 保存された動画の管理
        let savedVideos = JSON.parse(localStorage.getItem('savedVideos') || '[]');

        function saveVideo() {
            const url = document.getElementById('saved-video-url').value.trim();
            const name = document.getElementById('video-name-input').value.trim();
            
            if (!url) {
                showMessage("URLを入力してください", 2000);
                return;
            }
            
            if (!name) {
                showMessage("動画の名前を入力してください", 2000);
                return;
            }

            const { videoId, playlistId } = extractYouTubeVideoId(url);
            if (!videoId && !playlistId) {
                showMessage("無効なYouTube URLです", 2000);
                return;
            }

            // 重複チェック
            if (savedVideos.some(video => video.name === name)) {
                showMessage("この名前は既に使用されています", 2000);
                return;
            }

            savedVideos.push({
                name,
                videoId,
                playlistId,
                url
            });

            localStorage.setItem('savedVideos', JSON.stringify(savedVideos));
            renderSavedVideos();
            clearVideoForm();
            showMessage("動画を保存しました", 2000);
        }

        function clearVideoForm() {
            document.getElementById('saved-video-url').value = '';
            document.getElementById('video-name-input').value = '';
        }

        // クリアボタンのイベントリスナー
        document.getElementById('clear-form-btn').addEventListener('click', clearVideoForm);

        function renderSavedVideos() {
            const container = document.getElementById('saved-videos-list');
            container.innerHTML = '';

            savedVideos.forEach((video, index) => {
                const item = document.createElement('div');
                item.className = 'saved-video-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'saved-video-name';
                nameSpan.textContent = video.name;
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'saved-video-buttons';
                
                const loadBtn = document.createElement('button');
                loadBtn.className = 'saved-video-btn';
                loadBtn.innerHTML = '<i class="fas fa-play"></i>';
                loadBtn.title = 'この動画を読み込む';
                loadBtn.onclick = () => loadSavedVideo(video);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'saved-video-btn delete';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'この動画を削除';
                deleteBtn.onclick = () => deleteSavedVideo(index);
                
                buttonsDiv.appendChild(loadBtn);
                buttonsDiv.appendChild(deleteBtn);
                
                item.appendChild(nameSpan);
                item.appendChild(buttonsDiv);
                container.appendChild(item);
            });
        }

        function loadSavedVideo(video) {
            const currentVolume = ytPlayer && typeof ytPlayer.getVolume === 'function' ? ytPlayer.getVolume() : 50;
            
            // 既存のプレーヤーを破棄
            if (ytPlayer && typeof ytPlayer.destroy === 'function') {
                ytPlayer.destroy();
                ytPlayer = null;
            }
            document.getElementById('youtube-player-background').innerHTML = '';
            
            // 新しいプレーヤーを作成
            loadYouTubeVideo({ videoId: video.videoId, playlistId: video.playlistId }, currentVolume);
            youtubeSettingsPanel.style.display = 'none';
            showMessage(`${video.name}を読み込みました`, 2000);
        }

        function deleteSavedVideo(index) {
            savedVideos.splice(index, 1);
            localStorage.setItem('savedVideos', JSON.stringify(savedVideos));
            renderSavedVideos();
            showMessage("動画を削除しました", 2000);
        }

        // タブ切り替え
        document.querySelectorAll('.settings-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // タブのアクティブ状態を切り替え
                document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // コンテンツの表示を切り替え
                document.querySelectorAll('.settings-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
            });
        });

        // 保存ボタンのイベントリスナー
        document.getElementById('save-video-btn').addEventListener('click', saveVideo);

        // 初期表示
        renderSavedVideos();

        window.addEventListener('load', () => {
            updateClock();
            loadTasksFromLocalStorage();
            updatePomodoroDisplay();
            loadYouTubeAPI();
            showMessage("右下の歯車アイコンから背景動画を設定できます。", 4000);
            loadSettings();
            const savedCollapsed = localStorage.getItem('pomodoroCollapsed');
            if (savedCollapsed === 'true') {
                togglePomodoro();
            }
            const savedTasksCollapsed = localStorage.getItem('tasksCollapsed');
            if (savedTasksCollapsed === 'true') {
                toggleTasks();
            }
            initializeAudio();
        });
    </script>
</body>
</html>
